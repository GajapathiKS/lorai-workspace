name: Publish Docker Image

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-push:
    name: Build & Push to Docker Hub
    runs-on: ubuntu-latest
    environment: dockerhub

    steps:
      - uses: actions/checkout@v4

      - name: Extract version and image tags
        id: meta
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
          else
            VERSION=$(python3 -c "
          import tomllib
          with open('lorai-sdk/pyproject.toml', 'rb') as f:
              data = tomllib.load(f)
          print(data['project']['version'])
          ")
          fi
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f1-2)
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/lorai-workspace"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "MAJOR=$MAJOR" >> $GITHUB_OUTPUT
          echo "MINOR=$MINOR" >> $GITHUB_OUTPUT
          echo "IMAGE=$IMAGE" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image
        run: |
          IMAGE="${{ steps.meta.outputs.IMAGE }}"
          VERSION="${{ steps.meta.outputs.VERSION }}"
          MAJOR="${{ steps.meta.outputs.MAJOR }}"
          MINOR="${{ steps.meta.outputs.MINOR }}"
          docker build \
            --label "org.opencontainers.image.title=LorAI Workspace" \
            --label "org.opencontainers.image.description=AI-first operating environment â€” All of AI. One Command. Port 1842." \
            --label "org.opencontainers.image.version=${VERSION}" \
            --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
            --label "org.opencontainers.image.licenses=MIT" \
            -t "${IMAGE}:${VERSION}" \
            -t "${IMAGE}:${MINOR}" \
            -t "${IMAGE}:${MAJOR}" \
            -t "${IMAGE}:latest" \
            -f ./lorai/Dockerfile \
            ./lorai

      - name: Push Docker image
        run: |
          IMAGE="${{ steps.meta.outputs.IMAGE }}"
          VERSION="${{ steps.meta.outputs.VERSION }}"
          MAJOR="${{ steps.meta.outputs.MAJOR }}"
          MINOR="${{ steps.meta.outputs.MINOR }}"
          docker push "${IMAGE}:${VERSION}"
          docker push "${IMAGE}:${MINOR}"
          docker push "${IMAGE}:${MAJOR}"
          docker push "${IMAGE}:latest"
